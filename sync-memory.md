---
description: 同步/更新分层记忆系统（近期层→卷级层→全书层）
argument-hint: [init|sync|卷号] （init=初始化，sync=全量同步，卷号=同步指定卷）
---

# 分层记忆同步：$ARGUMENTS

**管理长篇小说的三层记忆系统，解决100万字+作品的上下文问题。**

---

## 分层记忆架构

```
┌─────────────────────────────────────────────────────────────┐
│                      全书层（长期记忆）                        │
│  伏笔追踪 | 人物里程碑 | 已用套路 | 感情节点 | 势力变化         │
│                    ↑ 每卷结束时归档                           │
├─────────────────────────────────────────────────────────────┤
│                      卷级层（中期记忆）                        │
│        卷内事件摘要 | 卷内伏笔 | 卷内关系变化                   │
│                    ↑ 每章写完时更新                           │
├─────────────────────────────────────────────────────────────┤
│                      近期层（短期记忆）                        │
│        人物当前状态 | 叙事手法记录（最近10章）                  │
│                    ↑ 每章写完时更新                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 使用场景

### 场景1：初始化（init）
新项目首次使用，创建完整的三层记忆结构。

### 场景2：全量同步（sync）
已有多卷内容，需要从头分析并填充所有层级。

### 场景3：卷级同步（卷号）
指定卷写完后，将卷级记忆归档到全书层。

---

## 执行流程

### 步骤1：读取项目信息

1. `AGENTS.md` - 获取项目结构和人物列表
2. `小说规划.md` - 获取全书规划
3. 已有的卷大纲和章节内容

---

### 步骤2：创建/检查目录结构

```
[书名]/
├── 动态状态/                    # 近期层
│   ├── 人物当前状态.md
│   └── 叙事手法记录.md
│
├── 全书记忆/                    # 全书层（长期记忆）
│   ├── 伏笔追踪表.md           # 必须：跨卷伏笔
│   ├── 人物里程碑.md           # 必须：人物成长关键节点
│   ├── 已用套路库.md           # 必须：防重复的场景/套路/梗
│   ├── 感情线节点.md           # 按需：感情发展关键时刻
│   ├── 势力变化表.md           # 按需：势力/敌人演变（权谋/宫斗）
│   └── 世界线进度.md           # 按需：大事件时间线（末世/穿越）
│
└── 卷X-卷名/
    └── 章节摘要.md              # 卷级层（本卷记忆）
```

### 按需创建判断规则

| 文件 | 创建条件 |
|------|----------|
| 伏笔追踪表.md | **必须创建** |
| 人物里程碑.md | **必须创建** |
| 已用套路库.md | **必须创建** |
| 感情线节点.md | 感情线比重 ≥ 10% 或 有明确女主设定 |
| 势力变化表.md | 题材为权谋/宫斗/群像/战争 或 主角需要建立势力 |
| 世界线进度.md | 题材为末世/穿越/时间线复杂 或 有明确时间跨度设定 |

---

### 步骤3：初始化全书记忆文件

#### 3.1 伏笔追踪表

**文件：`全书记忆/伏笔追踪表.md`**

```markdown
# 伏笔追踪表

> 记录全书所有伏笔的埋设与回收，防止遗漏。
> 最后更新：第X章

---

## 伏笔状态统计

| 状态 | 数量 |
|------|------|
| 🔴 待回收 | X个 |
| 🟡 部分回收 | X个 |
| 🟢 已回收 | X个 |
| ⚫ 已废弃 | X个 |

---

## 长线伏笔（跨卷）

| ID | 伏笔内容 | 埋设章节 | 预计回收 | 实际回收 | 状态 |
|----|----------|----------|----------|----------|------|
| L001 | [伏笔描述] | 第X章 | 卷X | - | 🔴 待回收 |
| L002 | [伏笔描述] | 第X章 | 卷X | 第X章 | 🟢 已回收 |

---

## 中线伏笔（卷内）

### 卷一
| ID | 伏笔内容 | 埋设章节 | 回收章节 | 状态 |
|----|----------|----------|----------|------|
| V1-001 | [伏笔描述] | 第X章 | 第X章 | 🟢 |

### 卷二
...

---

## 短线伏笔（5章内回收）

> 短线伏笔回收后可删除，只保留最近的

| 伏笔内容 | 埋设 | 回收 |
|----------|------|------|
| [描述] | 第X章 | 第X章 |

---

## 伏笔关联图

```
[主线伏笔A] ─── 触发 ──→ [支线伏笔B]
     │                        │
     └──── 同时回收 ────────┘
```

---

## 待处理提醒

> 超过预计回收时间仍未回收的伏笔

⚠️ L003：[伏笔内容] - 预计卷二回收，当前已到卷三
```

---

#### 3.2 人物里程碑

**文件：`全书记忆/人物里程碑.md`**

```markdown
# 人物里程碑

> 记录主要角色的成长关键节点，确保人物弧光清晰。
> 最后更新：第X章

---

## 主角 - [名字]

### 成长轨迹
```
卷一：[起点状态] 
  │
  ├─ 第X章：[里程碑事件] → [状态变化]
  │
  ├─ 第X章：[里程碑事件] → [状态变化]
  │
卷二：[阶段状态]
  │
  ...
```

### 关键里程碑表

| 章节 | 事件 | 变化类型 | 变化内容 |
|------|------|----------|----------|
| 第1章 | 重生 | 心态 | 从绝望→复仇决心 |
| 第15章 | 首次杀人 | 性格 | 突破心理障碍 |
| 第30章 | 队伍成型 | 身份 | 从独狼→领袖 |
| 第45章 | 失去XXX | 情感 | 更加冷酷 |

### 能力成长节点

| 章节 | 突破/获得 | 战力评估 |
|------|-----------|----------|
| 第X章 | [能力] | ★★☆☆☆ |
| 第X章 | [能力] | ★★★☆☆ |

---

## 女主1 - [名字]

### 感情里程碑

| 章节 | 事件 | 感情阶段 | 亲密度 |
|------|------|----------|--------|
| 第X章 | 初遇 | 相遇 | ★☆☆☆☆ |
| 第X章 | [事件] | 相识 | ★★☆☆☆ |
| 第X章 | [事件] | 心动 | ★★★☆☆ |

### 个人成长节点

| 章节 | 事件 | 变化 |
|------|------|------|
| 第X章 | [事件] | [变化] |

---

## [其他重要角色]

[按需添加]
```

---

#### 3.3 已用套路库

**文件：`全书记忆/已用套路库.md`**

```markdown
# 已用套路库

> 记录全书已使用的场景类型、套路、梗，防止重复。
> 写作前查阅，避免同质化。
> 最后更新：第X章

---

## ⚠️ 使用原则

1. **同类套路间隔至少20章**
2. **核心套路（打脸/名场面）间隔至少30章**
3. **完全相同的套路全书只用1次**
4. **相似套路需要有明显变化**

---

## 一、开场方式

| 类型 | 已用章节 | 最近使用 | 间隔建议 |
|------|----------|----------|----------|
| 动作场面开头 | 3, 25, 48, 72 | 第72章 | ✅ 可用 |
| 对话冲突开头 | 8, 31, 55 | 第55章 | ✅ 可用 |
| 梦境/回忆开头 | 1, 40 | 第40章 | ✅ 可用 |
| 悬念提问开头 | 15, 38, 62 | 第62章 | ⚠️ 近期用过 |
| 环境渲染开头 | 20, 50 | 第50章 | ✅ 可用 |
| 时间跳跃开头 | 35 | 第35章 | ✅ 可用 |

---

## 二、打脸方式

| 类型 | 已用章节 | 描述 | 间隔建议 |
|------|----------|------|----------|
| 实力碾压 | 12, 45, 78 | 直接武力压制 | ⚠️ 用得较多 |
| 揭露真相 | 28, 60 | 揭穿对方谎言/阴谋 | ✅ 可用 |
| 身份反转 | 34 | 亮出隐藏身份 | ✅ 可用 |
| 借刀杀人 | 52 | 借他人之手 | ✅ 可用 |
| 以彼之道 | 67 | 用对方的方式反击 | ✅ 可用 |
| 群众打脸 | - | 围观群众反应 | 🆕 未用过 |

---

## 三、感情名场面

| 类型 | 已用章节 | 角色 | 间隔建议 |
|------|----------|------|----------|
| 英雄救美 | 18, 55 | 女主A, 女主B | ⚠️ 换个方式 |
| 雨中/雪中场景 | 42 | 女主A | ✅ 可用 |
| 生死相依 | 70 | 女主A | ✅ 可用 |
| 吃醋争风 | 38, 65 | 女主A/B | ⚠️ 近期用过 |
| 误会分离 | - | - | 🆕 未用过 |
| 并肩作战 | 30, 58 | 女主A | ✅ 可用 |

---

## 四、战斗套路

| 类型 | 已用章节 | 间隔建议 |
|------|----------|----------|
| 以弱胜强 | 15, 45, 80 | ⚠️ 注意变化 |
| 绝境逆转 | 25, 60 | ✅ 可用 |
| 团队配合 | 35, 70 | ✅ 可用 |
| 一对多 | 10, 40, 75 | ⚠️ 用得较多 |
| 智取 | 50 | ✅ 可用 |
| 偷袭/埋伏 | 20, 55 | ✅ 可用 |

---

## 五、剧情套路

| 类型 | 已用章节 | 描述 | 间隔建议 |
|------|----------|------|----------|
| 背叛反转 | 30 | XXX背叛 | ✅ 可用 |
| 意外重逢 | 22, 58 | 遇到熟人 | ✅ 可用 |
| 比赛/竞争 | 40 | 资源争夺 | ✅ 可用 |
| 卧底揭露 | - | - | 🆕 未用过 |
| 时间紧迫 | 35, 65 | 限时任务 | ✅ 可用 |

---

## 六、已用经典台词/梗

> 特色台词只用一次，避免重复

| 台词/梗 | 章节 | 场景 |
|---------|------|------|
| "[经典台词1]" | 第X章 | [场景] |
| "[经典台词2]" | 第X章 | [场景] |

---

## 七、下章建议

> 根据统计自动生成

**建议尝试（长期未用）**：
- 开场：[类型]（已X章未用）
- 打脸：[类型]（已X章未用）
- 感情：[类型]（全书未用）

**建议避免（近期已用）**：
- [类型]（第X章刚用）
- [类型]（连续用了X次）
```

---

#### 3.4 感情线节点

**文件：`全书记忆/感情线节点.md`**

```markdown
# 感情线节点

> 记录所有感情线的关键发展节点，确保感情戏不重复、有递进。
> 最后更新：第X章

---

## 感情线总览

| 角色 | 当前阶段 | 亲密度 | 最近互动 | 下一节点 |
|------|----------|--------|----------|----------|
| 女主A | 心动 | ★★★☆☆ | 第X章 | 表白（预计第X章） |
| 女主B | 相识 | ★★☆☆☆ | 第X章 | 共患难（预计第X章） |

---

## 女主A - [名字]

### 感情发展时间线

```
第X章 ─ 相遇 ─ [场景描述]
    │
第X章 ─ 相识 ─ [场景描述]
    │
第X章 ─ 好感 ─ [场景描述]
    │
第X章 ─ 心动 ─ [场景描述]  ← 当前
    │
第X章 ─ 表白 ─ [预计]
    │
    ...
```

### 关键节点详情

| 章节 | 节点类型 | 事件 | 感情变化 | 名场面类型 |
|------|----------|------|----------|------------|
| 第X章 | 相遇 | [事件] | 陌生→注意 | 英雄救美 |
| 第X章 | 升温 | [事件] | 注意→好感 | 并肩作战 |
| 第X章 | 心动 | [事件] | 好感→心动 | 生死相依 |

### 互动统计

| 互动类型 | 次数 | 章节 |
|----------|------|------|
| 救援 | 2 | 18, 55 |
| 日常甜蜜 | 5 | 25, 32, 48, 60, 75 |
| 冲突/误会 | 1 | 40 |
| 并肩战斗 | 3 | 30, 58, 72 |

### 待安排节点

- [ ] 表白场景（预计第X章）
- [ ] 确定关系后的考验
- [ ] ...

---

## 女主B - [名字]

[同上格式]

---

## 感情线冲突记录

| 冲突 | 章节 | 涉及角色 | 解决章节 | 状态 |
|------|------|----------|----------|------|
| [冲突1] | 第X章 | A, B | 第X章 | ✅ 已解决 |
| [冲突2] | 第X章 | A | - | 🔴 待解决 |

---

## 吃醋/争风记录

> 控制频率，避免过多

| 章节 | 场景 | 涉及角色 | 间隔上次 |
|------|------|----------|----------|
| 第X章 | [场景] | A, B | - |
| 第X章 | [场景] | A, B | X章 |

**建议**：下次吃醋戏至少间隔X章
```

---

#### 3.5 势力变化表（按需创建）

> **创建条件**：题材为权谋/宫斗/群像/战争 或 主角需要建立势力
> 
> 轻松爽文、系统流、个人向作品通常不需要此文件

**文件：`全书记忆/势力变化表.md`**

```markdown
# 势力变化表

> 追踪主要势力的发展变化，确保势力消长合理。
> 最后更新：第X章

---

## 势力格局总览

### 当前势力分布（第X章）

```
          [终极反派势力]
               │
    ┌──────────┼──────────┐
    │          │          │
[势力A]    [势力B]    [势力C]
    │                     │
    └───── 敌对 ─────────┘
              │
         [主角势力]
              │
    ┌─────────┼─────────┐
    │         │         │
 [盟友1]   [盟友2]   [盟友3]
```

---

## 主角势力发展

| 阶段 | 章节 | 事件 | 成员 | 资源 | 势力评级 |
|------|------|------|------|------|----------|
| 起步 | 第1章 | 独自一人 | 1人 | 少 | ★☆☆☆☆ |
| 发展 | 第X章 | 收服XXX | X人 | 中 | ★★☆☆☆ |
| 壮大 | 第X章 | 建立基地 | X人 | 较多 | ★★★☆☆ |

---

## 敌对势力变化

### [势力名/反派名]

| 章节 | 事件 | 实力变化 | 与主角关系 |
|------|------|----------|------------|
| 第X章 | 首次出场 | 强 | 潜在威胁 |
| 第X章 | 首次冲突 | 强 | 明确敌对 |
| 第X章 | 被削弱 | 中 | 敌对 |
| 第X章 | 被清算 | 消灭 | - |

---

## 仇人清算进度

| 仇人 | 仇恨等级 | 预计清算 | 实际清算 | 状态 |
|------|----------|----------|----------|------|
| XXX | ★★★★★ | 卷五 | - | 🔴 存活 |
| XXX | ★★★★☆ | 卷三 | 第X章 | ✅ 已清算 |
| XXX | ★★★☆☆ | 卷二 | 第X章 | ✅ 已清算 |

---

## 盟友/中立势力

| 势力 | 首次接触 | 当前关系 | 关系变化记录 |
|------|----------|----------|--------------|
| [势力A] | 第X章 | 盟友 | 中立→合作→盟友 |
| [势力B] | 第X章 | 中立 | - |
```

---

#### 3.6 世界线进度（按需创建）

> **创建条件**：题材为末世/穿越/时间线复杂 或 有明确时间跨度设定
> 
> 普通玄幻、都市、系统流作品通常不需要此文件

**文件：`全书记忆/世界线进度.md`**

```markdown
# 世界线进度

> 记录世界/剧情大事件时间线，确保时间逻辑一致。
> 最后更新：第X章

---

## 时间线总览

```
[灾变前X天] ─── 主角重生
      │
[灾变第1天] ─── 灾变爆发
      │
[灾变第X天] ─── [事件] ← 当前进度
      │
[灾变第X天] ─── [预计事件]
      │
      ...
```

---

## 详细时间线

### 灾变前

| 时间 | 章节 | 事件 | 影响 |
|------|------|------|------|
| 灾变前7天 | 第1章 | 主角重生 | 开始囤货 |
| 灾变前3天 | 第X章 | [事件] | [影响] |

### 灾变后

| 时间 | 章节 | 事件 | 影响 |
|------|------|------|------|
| 第1天 | 第X章 | 灾变爆发 | 社会崩溃 |
| 第3天 | 第X章 | [事件] | [影响] |
| 第7天 | 第X章 | [事件] | [影响] |
| 第15天 | 第X章 | [事件] | [影响] |

---

## 当前世界状态

- **当前时间**：灾变第X天
- **当前位置**：[地点]
- **大环境**：[描述]
- **近期大事件**：[事件]

---

## 预计未来事件

| 预计时间 | 事件 | 规划章节 |
|----------|------|----------|
| 灾变第X天 | [事件] | 第X章 |
| 灾变第X天 | [事件] | 卷X |

---

## 地点变迁记录

| 章节范围 | 主要地点 | 备注 |
|----------|----------|------|
| 第1-10章 | [地点A] | 初始据点 |
| 第11-25章 | [地点B] | 转移 |
| 第26-40章 | [地点C] | 新基地 |
```

---

### 步骤4：同步已有内容（sync模式）

如果是同步已有章节：

1. **读取项目信息**：`AGENTS.md` 获取题材、基调、感情线比重
2. **读取所有卷的章节摘要和章节内容**
3. **分析提取**（按需）：
   - 伏笔埋设与回收 → **必须**
   - 人物成长节点 → **必须**
   - 使用过的套路/名场面 → **必须**
   - 感情线关键节点 → **按需**（有感情线时）
   - 势力变化 → **按需**（权谋/宫斗时）
   - 时间线事件 → **按需**（末世/穿越时）
4. **填充全书记忆文件**（只创建需要的文件）
5. **生成统计和建议**

---

### 步骤5：卷级归档（指定卷号）

当某卷完成时：

1. **读取该卷所有章节摘要**
2. **提取该卷的关键信息**
3. **归档到全书层**（只更新存在的文件）：
   - 长线伏笔 → 伏笔追踪表
   - 人物关键变化 → 人物里程碑
   - 新用的套路 → 已用套路库
   - 感情进展 → 感情线节点（如文件存在）
   - 势力变化 → 势力变化表（如文件存在）
   - 大事件 → 世界线进度（如文件存在）
4. **清理近期层过期数据**

---

## 输出确认

```
===== 分层记忆同步完成 =====

模式：[init/sync/卷X归档]
处理范围：[范围描述]

已创建/更新文件：
✓ 全书记忆/伏笔追踪表.md
✓ 全书记忆/人物里程碑.md
✓ 全书记忆/已用套路库.md
✓ 全书记忆/感情线节点.md
✓ 全书记忆/势力变化表.md
✓ 全书记忆/世界线进度.md
✓ 动态状态/人物当前状态.md
✓ 动态状态/叙事手法记录.md

统计摘要：
- 长线伏笔：X个待回收
- 人物里程碑：主角X个，女主X个
- 已用套路：开场X种，打脸X种，感情X种
- 感情进展：[女主A] ★★★☆☆，[女主B] ★★☆☆☆
- 仇人清算：已清算X人，剩余X人
- 当前时间线：灾变第X天

下章写作建议：
- 待回收伏笔：[最近该回收的]
- 建议尝试：[长期未用的套路]
- 建议避免：[近期用过的套路]

=============================
```

---

## 与其他命令的联动

| 命令 | 读取 | 更新 |
|------|------|------|
| `/auto-write` | 全部三层 | 近期层 + 卷级层 |
| `/batch-write` | 全部三层 | 近期层 + 卷级层 |
| `/update-status` | 近期层 | 近期层 |
| `/sync-memory` | - | 全部三层 |
| `/check-consistency` | 全部三层 | - |

---

## 推荐使用频率

| 操作 | 频率 |
|------|------|
| 近期层更新 | 每章自动 |
| 卷级归档 | 每卷结束时 |
| 全量同步 | 每50章或感觉混乱时 |
| 检查套路库 | 每10章主动查看 |

---

## 注意事项

1. **全书层要精简**：只记录关键信息，不是复制全文
2. **及时归档**：每卷结束后运行 `/sync-memory 卷号`
3. **主动查阅套路库**：写作前看看哪些套路该换了
4. **伏笔必须追踪**：长线伏笔忘记回收是大忌
5. **感情线要递进**：通过节点表确保不开倒车
